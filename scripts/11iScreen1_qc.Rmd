---
title: "11iScreen1 QC"
author: "Andreas Gschwind"
date: "`r format(Sys.time(), '%B %d, %Y')`"
params:
  rmd: "11iScreen1_qc.Rmd"
output:
  bookdown::html_document2:
    toc: yes
---

# Goal
General QC of 11iScreen1 perturbations and DGE data.
```{css echo=FALSE}
/* Define a margin before every image element */
img {
  margin-top: 3em;
}
```

```{r setup, include=FALSE}
# set global chunk options
knitr::opts_chunk$set(echo = FALSE)

# attach required packages
library(tidyverse)
library(gridExtra)
library(ggrepel)
library(GGally)
library(here)
```

```{r prepData}
# load target genes
target_genes <- read.csv(here(snakemake@input$target_genes), stringsAsFactors = FALSE)

# load dge data
dge <- read.table(here(snakemake@input$dge), header = TRUE, stringsAsFactors = FALSE,
                  row.names = "GENE")

# dge input files from chr11 validation experiments
valid_dge_files <- grep(snakemake@input$valid_dge, pattern = "11iv2", value = TRUE)
valid_dge_files <- here(valid_dge_files)
names(valid_dge_files) <- basename(dirname(valid_dge_files))

# load validation dge data
valid_dge <- lapply(valid_dge_files, FUN = read.table, header = TRUE, stringsAsFactors = FALSE)

# load perturbation status
perturb_status <- read.table(here(snakemake@input$pert), header = TRUE, stringsAsFactors = FALSE,
                             row.names = "VECTOR")

# load experimental meta data and extract data on 11i samples
exp_data <- read.csv(here(snakemake@input$exp_data), stringsAsFactors = FALSE) %>%
  filter(panel == "chr11i")

# get transfected vector ids
vectors_file <- here(snakemake@input$vctr_seqs)
vectors <- vectors_file %>%
  readLines() %>%
  grep(pattern = "^>.+$", perl = TRUE, value = TRUE) %>%
  sub(., pattern = ">", replacement = "") %>%
  data.frame(vector = ., stringsAsFactors = FALSE)

# extract vector expression from dge data
vector_pattern <- snakemake@params$vector_pattern
vector_rows <- grep(rownames(dge), pattern = vector_pattern)
vctr_expr <- dge[vector_rows, ]

# extract gene expression data
gene_expr <- dge[-vector_rows, ]
```

# Batch effects
DGE data is assessed for any batch effects. Metadata on individual 10x lanes is used to assign each
cell to its batch.

## PCA full DGE
PCA is performed on the full dge dataset to check whether any outlier samples can be identified.

```{r PCAallDGE, fig.height = 7}
# convert dge into data matrix and transpose for pca
dge_mat <- t(data.matrix(dge))

# compute PCA on DGE data
pca_dge <- prcomp(dge_mat, scale. = TRUE)

# extract scores of each cell for pc1 & pc2
pcs <- pca_dge$x[, 1:2] %>%
  as.data.frame() %>%
  rownames_to_column(var = "cell_barcode")

# split cell barcode into i7 and cell and meta data to each cell
pcs <- pcs %>%
  separate(cell_barcode, sep = 8, into = c("i7_index", "cell")) %>%
  mutate(i7_index = replace(i7_index, i7_index == "CGAACTAG", "CGTACTAG")) %>%  # correct i7 error !!!!!
  left_join(select(exp_data, i7_index, chip_10x, lane_10x, bead_vial_10x), by = "i7_index") %>%
  gather(key = "type_10x", value = "value", -c(i7_index, cell, PC1, PC2))

# get variance explained for pcs
pca_sum <- summary(pca_dge)
var_expl <- pca_sum$importance["Proportion of Variance", ]

# create axis labels
x_axis <- paste0("PC1 (", (round(var_expl["PC1"], digits = 4) * 100), "% variance explained)")
y_axis <- paste0("PC2 (", (round(var_expl["PC2"], digits = 4) * 100), "% variance explained)")

# plot pca results
ggplot(pcs, aes(x = PC1, y = PC2, color = as.factor(value))) +
  facet_wrap(~type_10x, ncol = 2) +
  geom_point(size = 1, alpha = 0.2) +
  labs(x = x_axis, y = y_axis, color = "identifier", title = "PCA full dge") +
  coord_fixed() +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_bw()
```

## PCA gene expression
Because tha majority of variables are transfected CROP-seq vectors, which are highly variable, only
a little variation can be explained by PCA. Therefore the same analysis is repeated with only
expression of genes.

```{r PCAgenex, fig.height = 7}
# convert gene expression into data matrix and transpose for pca
genex_mat <- t(data.matrix(gene_expr))

# compute PCA on DGE data
pca_genex <- prcomp(genex_mat, scale. = TRUE)

# extract scores of each cell for pc1 & pc2
pcs <- pca_genex$x[, 1:2] %>%
  as.data.frame() %>%
  rownames_to_column(var = "cell_barcode")

# split cell barcode into i7 and cell and meta data to each cell
pcs <- pcs %>%
  separate(cell_barcode, into = c("i7_index", "cell"), sep = 8) %>%
  mutate(i7_index = replace(i7_index, i7_index == "CGAACTAG", "CGTACTAG")) %>%  # correct i7 error !!!!!
  left_join(select(exp_data, i7_index, chip_10x, lane_10x, bead_vial_10x), by = "i7_index") %>%
  gather(key = "type_10x", value = "value", -c(i7_index, cell, PC1, PC2))

# get variance explained for pcs
pca_sum <- summary(pca_genex)
var_expl <- pca_sum$importance["Proportion of Variance", ]

# create axis labels
x_axis <- paste0("PC1 (", (round(var_expl["PC1"], digits = 4) * 100), "% variance explained)")
y_axis <- paste0("PC2 (", (round(var_expl["PC2"], digits = 4) * 100), "% variance explained)")

# plot pca results
ggplot(pcs, aes(x = PC1, y = PC2, color = as.factor(value))) +
  facet_wrap(~type_10x, ncol = 2) +
  geom_point(size = 1, alpha = 0.2) +
  labs(x = x_axis, y = y_axis, color = "Identifier", title = "PCA gene expression") +
  coord_fixed() +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_bw()
```

## Compare 10x lanes
The number of cells and the average gene expression is plotted per i7 index, which correspond to
individual 10x lanes used in parallel to process the high number of cells.

```{r plotAvgGenex, fig.height=7, fig.width=5}
# transpose gene expression, make cell barcode a column and split into i7 + cell
gene_expr <- t(gene_expr) %>%
  as.data.frame() %>%
  rownames_to_column(var = "cell_barcode") %>%
  separate(cell_barcode, into = c("i7_index", "cell"), sep = 8) %>%
  mutate(i7_index = replace(i7_index, i7_index == "CGAACTAG", "CGTACTAG")) %>%  # correct i7 error !!!!!
  gather(key = "gene", value = "txs", -c(i7_index, cell))

# count the number of cells per i7 index
cells <- gene_expr %>%
  group_by(i7_index) %>%
  summarize(cells = n_distinct(cell))

# plot number of cells per 10x lane
p1 <- ggplot(cells, aes(x = i7_index, y = cells, fill = i7_index)) +
  geom_bar(stat = "identity") +
  labs(x = "i7 index", y = "Number of cells") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
  
# compute average gene expression per i7_index
avg_genex_i7 <- gene_expr %>%
  group_by(i7_index, gene) %>%
  summarize(avg_txs = mean(txs))

# plot average gene expression
p2 <- ggplot(avg_genex_i7, aes(x = i7_index, y = avg_txs, color = i7_index)) +
  geom_jitter(width = 0.25, alpha = 0.5) +
  geom_boxplot(color = "black", fill = NA, notch = TRUE, outlier.shape = NA) +
  labs(x = "i7 index", y = "Average transcripts per gene") +
  scale_y_log10() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

# print plots
grid.arrange(p1, p2, nrow = 2)
```

Pairwise correlation of average gene expression:

```{r pairwisePlots, fig.height=12, fig.width=12}
# calculate log10 average gene expression and reformat
avg_genex_i7_log10 <- avg_genex_i7 %>%
  mutate(avg_txs = log(avg_txs)) %>%
  spread(key = "i7_index", value = "avg_txs")

# plot pairwise correlations between 10x lanes
ggpairs(avg_genex_i7_log10, columns = 2:ncol(avg_genex_i7_log10), progress = FALSE)
```

# CROP-seq vectors
The number of detected transcripts and perturbations per transfected vector are assessed.

```{r vctrExpr, fig.height=10, fig.width=9}
# number of molecules per vector (all transfected vectors)
txs_per_vector <- rowSums(vctr_expr) %>%
  data.frame(vector = names(.), txs = ., stringsAsFactors = FALSE) %>%
  mutate(vector = sub(vector_pattern, "", vector)) %>%
  full_join(vectors, by = "vector") %>%
  mutate(txs = replace(txs, is.na(txs), 0))

# compute the number of cells per perturbation
cells_per_pert <- rowSums(perturb_status) %>%
  data.frame(vector = names(.), cells = ., stringsAsFactors = FALSE)

# merge with txs_per_vector and calculate average vector txs per transfected cell (if possible)
vector_stats <- txs_per_vector %>%
  full_join(cells_per_pert, by = "vector") %>%
  mutate(cells = replace(cells, is.na(cells), 0)) %>%
  mutate(avg_txs = if_else(cells > 0, true = txs / cells, false = as.numeric(NA)))

# add label for control vectors
ctrl_vctrs <- grep(vector_stats$vector, pattern = "^chr11:.+$", perl = TRUE,
                   invert = TRUE, value = TRUE)

vector_stats <- vector_stats %>%
  mutate(type = if_else(vector %in% ctrl_vctrs, true = "ctrl", false = "screen"))

# plot total number of detected transcripts per vector
p11 <- ggplot(vector_stats,
              aes(x = fct_reorder(vector, txs, .desc = TRUE),y = txs, color = type)) +
  geom_point() +
  labs(x = "vectors", y = "transcripts", title = "Detected vector transcripts 11iScreen1") +
  theme_bw() +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), panel.grid = element_blank())

p12 <- ggplot(vector_stats, aes(txs)) +
  geom_histogram(bins = 50) +
  labs(title = "Detected vector transcripts 11iScreen1") +
  theme_bw()

# plot number of cells per perturbation
n_50_plus <- sum(vector_stats$cells >= 50)
title <- paste0("Cells per perturbation 11iScreen (", n_50_plus, " >= 50)")

p21 <- ggplot(vector_stats,
              aes(x = fct_reorder(vector, cells, .desc = TRUE),y = cells, color = type)) +
  geom_point() +
  geom_hline(yintercept = 50, lty = "dashed", col = "darkgray") +
  labs(x = "vectors", y = "cells", title = title) +
  theme_bw() +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), panel.grid = element_blank())

p22 <- ggplot(vector_stats, aes(cells)) +
  geom_histogram(bins = 50) +
  labs(title = "Cells per perturbation 11iScreen") +
  theme_bw()

# plot average expression per cell for successful vectors
p31 <- vector_stats %>%
  filter(cells > 0) %>%
  ggplot(., aes(x = fct_reorder(vector, avg_txs, .desc = TRUE), y = avg_txs, color = type)) +
  geom_point() +
  labs(x = "vectors", y = "txs per cell", title = "Txs per transfected cell 11iScreen1") +
  theme_bw() +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), panel.grid = element_blank())

p32 <- vector_stats %>%
  filter(cells > 0) %>%
  ggplot(., aes(avg_txs)) +
  geom_histogram(bins = 50) +
  labs(title = "Txs per transfected cell 11iScreen1") +
  theme_bw()

# print plots
grid.arrange(p11, p12, p21, p22, p31, p32, ncol = 2, nrow = 3)
```

# Gene expression

## Correlation with validation experiments
The average expression per gene is computed and correlated with data from the chr11 validation
experiments.

```{r genexCorrelation}
# compute average gene expression per gene
avg_genex <- gene_expr %>%
  group_by(gene) %>%
  summarize(avg_txs = mean(txs))

# known enhancer genes
known_enh <- target_genes %>%
  filter(screen == "validation") %>%
  filter(!gene %in% c("HBG1", "HBG2")) %>%  # HBG genes were removed from screen
  pull(gene)

# chr11 target genes
chr11_genes <- target_genes %>%
  filter(panel == "chr11_hs2", screen == "inhibition") %>%
  pull(gene) %>%
  c(known_enh)

# average gene expression in validation experiments
avg_genex_valid <- valid_dge %>%
  lapply(FUN = gather, key = "cell", value = "txs", -GENE) %>%
  bind_rows(.id = "sample") %>%
  filter(GENE %in% chr11_genes) %>%
  group_by(GENE) %>%
  summarize(avg_txs_valid = mean(txs))

# merge avg genex datasets and add variable for known enhancer target genes
avg_genex_merged <- full_join(avg_genex, avg_genex_valid, by = c("gene" = "GENE")) %>%
  mutate(type = if_else(gene %in% known_enh, true = "e-gene", "non_e-gene"))

# correlation plot
ggplot(avg_genex_merged, aes(x = avg_txs_valid, y = avg_txs, color = type)) +
  geom_abline() +
  geom_text_repel(data = filter(avg_genex_merged, type == "e-gene" | gene == "STK3"),
                  aes(label = gene), box.padding = unit(1.5, "lines"), color = "gray50") +
  geom_point() +
  labs(title = "Average gene expression", x = "11iv210ng & 11iv22ng", y = "11iScreen1") +
  scale_x_log10() +
  scale_y_log10() +
  coord_fixed() +
  theme_bw()
```

## Positive controls perturbation effects
Data on the validation enhancers is extracted and the LFC between cells carrying positive control
perturbations and non-targeting controls is calculated.

```{r grnasToTargets}
# get grna identifiers
grnas <- rownames(perturb_status)

# get indexes of screen grnas
screen_grnas <- grep(grnas, pattern = "^chr.+:\\d+-\\d+.*$", perl = TRUE)

# get non-targeting negative control grnas
neg_ctrls <- grep(grnas, pattern = "^non-targeting_.+$", perl = TRUE)

# convert grna ids to grna targets
grnas[screen_grnas] <- sub("_\\d+.+$", "", grnas[screen_grnas])
grnas[neg_ctrls] <- sub("_\\d+$", "", grnas[neg_ctrls])
grnas[-c(screen_grnas, neg_ctrls)] <- sub("[_|-].*" , "", grnas[-c(screen_grnas, neg_ctrls)])

# add targets as separate column to perturb_status
perturb_status <- data.frame(target = grnas, perturb_status, stringsAsFactors = FALSE)
```

```{r controlPerturbations}
# get rows containing negative or positive controls, or screen perturbations
targets <- perturb_status$target
neg_ctrl_rows    <- which(targets == "non-targeting")
screen_pert_rows <- grep(targets, pattern = "^chr11:.+$", perl = TRUE)
pos_ctrl_rows    <- which(!targets %in% c("non-targeting", perturb_status$target[screen_pert_rows]))

# get cells carrying non-targeting controls or any other enhancer perturbations
neg_ctrl <- colSums(perturb_status[neg_ctrl_rows, -1]) > 0
enh_pert <- colSums(perturb_status[c(screen_pert_rows, pos_ctrl_rows), -1]) > 0

# get cell barcodes of cells only carrying non-targeting controls
neg_ctrl_cells <- data.frame(neg_ctrl, enh_pert) %>%
  rownames_to_column(var = "cell") %>%
  filter(neg_ctrl == TRUE, enh_pert == FALSE) %>%
  pull(cell)

# get cells carrying any positive control perturbation
pos_ctrl <- colSums(perturb_status[pos_ctrl_rows, -1]) > 0
pos_ctrl_cells <- names(pos_ctrl[pos_ctrl])

# filter for control perturbations and cells carrying them
pert_ctrls <- perturb_status[c(pos_ctrl_rows, neg_ctrl_rows),
                             c("target", pos_ctrl_cells, neg_ctrl_cells)]

# transform to long format and count number of perturbations per cell and target
pert_ctrls <- gather(pert_ctrls, key = "cell_barcode", value = "pert", -target) %>%
  filter(pert > 0) %>%
  count(cell_barcode, target) %>%
  rename(pert = n)
```

```{r controlEffects, fig.height=18, fig.width=7}
# get gene expression data for cells carrying control perturbations
genex_pert <- gene_expr %>%
  unite(col = "cell_barcode", i7_index, cell, sep = "") %>%
  filter(cell_barcode %in% unique(pert_ctrls$cell_barcode))

# merge with perturbation information
genex_pert <- left_join(genex_pert, pert_ctrls, by = "cell_barcode")

# calculate average gene expression of each gene in every perturbation
avg_genex_pert <- genex_pert %>%
  group_by(target, gene) %>%
  summarize(avg_txs = mean(txs))

# reformat so that rows contain a positive control perturbation and negative control expression
avg_genex_pert <- avg_genex_pert %>%
  spread(key = target, value = avg_txs) %>%
  gather(key = target, value = avg_txs, -c("gene", "non-targeting")) %>%
  rename(neg_ctrl = "non-targeting") %>%
  select(gene, target, avg_txs, neg_ctrl)

# calculate log fold change for each gene in each perturbation
lfc_pert <- avg_genex_pert %>%
  filter(avg_txs > 0) %>%  # filter genes with detected expression for the given perturbations
  mutate(fc = avg_txs / neg_ctrl,
         lfc = log2(fc))

# list of perturbations and their target genes
perturbations <- as.list(unique(lfc_pert$target))
names(perturbations) <- unlist(perturbations)
perturbations$HS2 <- c("HBB", "HBD", "HBE1", "HBG1", "HBG2")

# add variable indicating if a gene is a target of the given perturbation
lfc_pert <- lfc_pert %>%
  group_by(target) %>%
  mutate(type = if_else(gene %in% unlist(perturbations[target]),
                        true = "target", false = "non_target"))

# plot lfc for all perturbations
ggplot(lfc_pert, aes(x = lfc, y = gene, color = type)) +
  facet_wrap(~target, ncol = 3) +
  geom_vline(xintercept = c(-1, 1), lty = "dashed", color = "darkgray") +
  geom_vline(xintercept = 0, color = "darkgray") +
  geom_point() +
  geom_text_repel(data = filter(lfc_pert, abs(lfc) > 0.75), aes(label = gene),
                  box.padding = unit(1.5, "lines"), color = "gray50") +
  labs(title = "LFC perturbations vs. negative controls") +
  theme_bw() +
  theme(axis.text.y = element_text(size = 5))
```

Non-target genes with LFC > 0.75 are considered potential false positives. Their expression levels
and proportion of cells with zero expression are calculated. Low expression and large number of
cells with no expression could make the observed LFC more prone to noise, leading to false
positives.

```{r, fig.width=11, fig.height=4}
# get average gene expression of non_targets that show a |lfc| > 0.75
potential_fp <- filter(lfc_pert, type == "non_target", abs(lfc) > 0.75) %>%
  pull(gene) %>%
  unique()

# get average expression of all genes and mark potential false positives
avg_genex_fp <- avg_genex %>%
  mutate(type = if_else(gene %in% potential_fp, true = "false_pos?", false = "other"))

# plot average expression of these genes vs other gene
p1 <- ggplot(avg_genex_fp, aes(x = type, y = avg_txs, fill = type, color = type)) +
  geom_dotplot(binaxis = "y", stackdir = "center", binwidth = 0.15) +
  geom_text_repel(data = filter(avg_genex_fp, type == "false_pos?"), aes(label = gene),
                  color = "gray50") +
  labs(title = "Average expression potential false positives") +
  scale_y_log10() +
  theme_bw()

# compute percentage of 0s for each gene
zeros <- gene_expr %>%
  group_by(gene) %>%
  summarize(zeros = sum(txs == 0), 
            prop_zeros = zeros / n()) %>%
  mutate(type = if_else(gene %in% potential_fp, true = "false_pos?", false = "other"))

# plot proportion of cells with zero expression
p2 <- ggplot(zeros, aes(x = type, y = prop_zeros, fill = type, color = type)) +
  geom_dotplot(binaxis = "y", stackdir = "center", binwidth = 0.025) +
  geom_text_repel(data = filter(zeros, type == "false_pos?"), aes(label = gene), color = "gray50") +
  labs(title = "Proportion of cells with 0s") +
  theme_bw()

# print plots
grid.arrange(p1, p2, ncol = 2)
```

# Source
* <a download="11iScreen1_qc.Rmd" href="`r base64enc::dataURI(file = params$rmd,
    mime = 'text/rmd', encoding = 'base64')`">R Markdown source file (to produce this document)</a>
