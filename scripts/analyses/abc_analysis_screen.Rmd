---
title: "ABC analysis enhancer screen"
author: "Andreas Gschwind"
date: "`r format(Sys.time(), '%B %d, %Y')`"
params:
  rmd: "abc_analysis_screen.Rmd"
output:
  bookdown::html_document2:
    toc: yes
---

# Goal
Available chromatin and Hi-C data was used to compute an activity-by-contact (ABC) score proposed by
[Fulco et al., 2019](https://www.biorxiv.org/content/10.1101/529990v1). See
\code{scripts/chromatin_annotated_etps/enhancer_screen_etps.R}. Here the predictive power of this
score is investigated by simple plots. More advanced can be found in \code{vignettes/Figure3hi.Rmd}.

```{css echo=FALSE}
/* Define a margin before every image element */
img {
  margin-top: 3em;
}
```

```{r setup, include=FALSE}
# set global chunk options
knitr::opts_chunk$set(echo = FALSE)

# attach required packages
library(here)
library(pROC)
library(tidyverse)
```

```{r loadPairs}
# load chromatin annotated ETPs generated by scripts/chromatin_annotated_etps/enhancer_screen_etps.R
pairs <- read.csv(here(snakemake@input), stringsAsFactors = FALSE)
```

# Enhancer activity score
The enhancer actvity score for is defined as the geometric mean between RPKM normalized DNAse and
H3K27ac reads overlapping each enhancer. Here the activity score is plotted against the Hi-C
interaction frequency. Significant enhancer - target pairs (ETPs) are highlighted by the proportion
of individual sgRNA hits, which can be interpreted as a confidence score for this enhancer - gene
association.
```{r activityScore, fig.width=10, fig.height=4}
# plot activity score vs interaction frequency
ggplot(pairs, aes(x = int_freq + 1, y = activity_score, color = prop_grna_hits)) +
  facet_wrap(~enh_chr, ncol = 2) +
  geom_point(data = filter(pairs, significant == 0), color = "gray69") +
  geom_point(data = filter(pairs, significant == 1)) +
  labs(x = "Hi-C interaction frequency", y = "Enhancer activity (DNAse + H3K27ac)",
       title = "Enhancer activity vs Hi-C contact frequency") +
  scale_color_gradient(low = "blue", high = "orangered", na.value = "gray69") +
  scale_x_log10() +
  scale_y_log10() +
  theme_bw()
```

# Activity-by-contact (ABC) score
Tha activity-by-contact (ABC) score is defined as the product of the acitvity score and the
normalized Hi-C interaction frequency. The ABC score is normalized per gene.

The ABC score is plotted against the distance to TSS and significant ETPs are highlighted by
the proportion of individual sgRNA hits:
```{r abcScore, warning=FALSE, fig.height=7, fig.width=7}
# plot abc score vs distance to TSS
ggplot(pairs, aes(x = dist_to_tss, y = abc_score_norm, color = prop_grna_hits)) +
  facet_wrap(~enh_chr, ncol = 1) +
  geom_point(data = filter(pairs, significant == 0), color = "gray69", alpha = 0.25) +
  geom_point(data = filter(pairs, significant == 1)) +
  labs(x = "Distance to TSS", y = "ABC score", "ABC score vs distance to TSS") +
  scale_color_gradient(low = "blue", high = "orangered", na.value = "gray69") +
  scale_x_log10() +
  scale_y_log10() +
  theme_bw()
```

The ABC score is plotted against the -log10 p-value, which is an indicator of the association
strength of a given ETP.
```{r, abcScoreVsPval, fig.height=3, fig.width=7}
# plot abc score vs pvalue
ggplot(pairs, aes(x = abc_score_norm, y = -log10(pvalue), color = as.factor(significant))) +
  facet_wrap(~enh_chr, ncol = 2) +
  geom_point() +
  labs(x = "ABC score", color = "Significant") +
  scale_color_manual(values = c("1" = "steelblue", "0" = "gray69")) +
  theme_bw()
```

# AUROC
The predictive power for different assays such as chromatin modifications, proximity and ABC score
is estimated using a simple AUROC analysis. For each predictor the AUROC is calculated to quantify
their predictive power to identify true enhancer - gene pairs.

## All pairs
The AUROC for the different assays is assessed for all pairs within the targeted regions. 
```{r, auroc, message=FALSE, fig.height=4, fig.width=6}
# function to calculate area under roc curve
calc_auroc <- function(category, prediction) {
  
  # order by prediction
  dat <- data.frame(category, prediction) %>%
    arrange(desc(prediction))
  
  # compute auc
  roc_obj <- roc(dat$category, dat$prediction)
  as.numeric(auc(roc_obj))
  
}

# only retain data on pairs that have at least one significant hit
sig_pairs <- pairs %>%
  group_by(sample, gene) %>%
  filter(sum(significant) > 0) %>%
  select(-c(2, 5:14, 23:29, 32))

# convert to long format and set pretty predictor names
sig_pairs_long <- sig_pairs %>%
  gather(key = "predictor", value = "predictor_value",
         -c(sample, perturbation, gene, significant)) %>%
  mutate(predictor = case_when(
    predictor == "int_freq" ~ "Hi-C int. freq.",
    predictor == "dist_to_tss" ~ "Distance to TSS",
    predictor == "activity_score" ~ "Activity score",
    predictor == "abc_score_norm" ~ "ABC score",
    TRUE ~ predictor))

# calculate auroc for all genes with significant enhancers
auroc <- sig_pairs_long %>%
  group_by(sample, predictor) %>%
  summarize(auc = calc_auroc(category = significant, prediction = predictor_value))

# plot auroc per gene and predictor
ggplot(auroc, aes(x = predictor, y = auc)) +
  facet_wrap(~sample, ncol = 2) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(y = "AUC", title = "AUROC") +
  coord_flip() +
  theme_bw() +
  theme(axis.title.x = element_blank())
```

```{r avgAuroc, fig.height=5, fig.width=7}
# calculate mean and median auroc
auroc_stats <- auroc %>%
  group_by(predictor) %>%
  summarize(avg_auroc = mean(auc),
            med_auroc = median(auc))

# add predictor type for plot
auroc_stats <- auroc_stats %>%
  mutate(type = case_when(
    predictor %in% c("H3K27ac", "H3K27me3", "H3K4me1", "H3K4me3") ~ "Histone PTM",
    predictor %in% c("Hi-C int. freq.", "Distance to TSS") ~ "Proximity",
    predictor %in% c("Activity score", "ABC score") ~ "ABC model",
    predictor == "Dnase.seq" ~ "DNA accessibility",
    predictor == "POLR2A" ~ "Transcription"))

# plot average auroc per predictor
ggplot(auroc_stats, aes(x = fct_reorder(predictor, desc(avg_auroc)), y = avg_auroc, fill = type)) +
  geom_bar(stat = "identity") +
  labs(x = "Predictor", y = "Average AUROC", fill = "Type") +
  scale_fill_brewer(palette = "Set1") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.title.x = element_blank())
```

## Enhancers within 1Mb
The AUROC for the different assays is assessed for all pairs with the enhancer within 1Mb of the
gene.
```{r, auroc1Mb, message = FALSE, fig.height=4, fig.width=6}
# only retain data on pairs that have at least one significant hit within 5 Mb of the TSS
sig_pairs_1mb <- pairs %>%
  group_by(sample, gene) %>%
  filter(dist_to_tss <= 1e6) %>%
  filter(sum(significant) > 0) %>%
  select(-c(2, 5:14, 23:29, 32))

# compute number of enhancers per gene
enh_per_gene <- summarize(sig_pairs_1mb, enhancers = n())

# plot number of enhancers per gene
ggplot(enh_per_gene, aes(x = gene, y = enhancers)) +
  facet_wrap(~sample, scales = "free_x") +
  geom_bar(stat = "identity") +
  labs(x = "Gene", y = "Enhancers", title = "Enhancers per gene within 1Mb") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# convert to long format and set pretty predictor names
sig_pairs_1mb_long <- sig_pairs_1mb %>%
  gather(key = "predictor", value = "predictor_value",
         -c(sample, perturbation, gene, significant)) %>%
  mutate(predictor = case_when(
    predictor == "int_freq" ~ "Hi-C int. freq.",
    predictor == "dist_to_tss" ~ "Distance to TSS",
    predictor == "activity_score" ~ "Activity score",
    predictor == "abc_score_norm" ~ "ABC score",
    TRUE ~ predictor))

# calculate auroc for all genes with significant enhancers
auroc_1mb <- sig_pairs_1mb_long %>%
  group_by(sample, predictor) %>%
  summarize(auc = calc_auroc(category = significant, prediction = predictor_value))

# plot auroc per gene and predictor
ggplot(auroc_1mb, aes(x = predictor, y = auc)) +
  facet_wrap(~sample, ncol = 2) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(y = "AUC", title = "AUROC 1Mb") +
  coord_flip() +
  theme_bw() +
  theme(axis.title.x = element_blank())
```

```{r avgAuroc1Mb, fig.height=5, fig.width=7}
# calculate mean and median auroc
auroc_stats_1mb <- auroc_1mb %>%
  group_by(predictor) %>%
  summarize(avg_auroc = mean(auc),
            med_auroc = median(auc))

# add predictor type for plot
auroc_stats_1mb <- auroc_stats_1mb %>%
  mutate(type = case_when(
    predictor %in% c("H3K27ac", "H3K27me3", "H3K4me1", "H3K4me3") ~ "Histone PTM",
    predictor %in% c("Hi-C int. freq.", "Distance to TSS") ~ "Proximity",
    predictor %in% c("Activity score", "ABC score") ~ "ABC model",
    predictor == "Dnase.seq" ~ "DNA accessibility",
    predictor == "POLR2A" ~ "Transcription"))

# plot average auroc per predictor
ggplot(auroc_stats_1mb, aes(x = fct_reorder(predictor, desc(avg_auroc)), y = avg_auroc,
                            fill = type)) +
  geom_bar(stat = "identity") +
  labs(x = "Predictor", y = "Average AUROC", fill = "Type") +
  scale_fill_brewer(palette = "Set1") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.title.x = element_blank())
```

This plot suggests that the ABC score is the best predictor for enhancer - gene pairs when
considering enhancers proximal to gene TSSs (1Mb).

# ROC within 1Mb
The receiver operator curves for the different assays and ABC score are plotted for all ETPs within
1Mb.
```{r, roc, message=FALSE, fig.height=9, fig.width=5}
# function to calculate roc curve
calc_roc <- function(category, prediction) {
  
  # order by prediction
  dat <- data.frame(category, prediction) %>%
    arrange(desc(prediction))
  
  # compute roc
  roc_obj <- roc(dat$category, dat$prediction)
  
  # return tpr and fpr
  data.frame(TPR = rev(roc_obj$sensitivities), FPR = rev(1 - roc_obj$specificities))

}

# calculate roc for all genes with significant enhancers
roc_1mb <- sig_pairs_1mb_long %>%
  group_by(sample, predictor) %>%
  do(calc_roc(category = .$significant, prediction = .$predictor_value))

# order according to average auroc
order <- auroc_stats_1mb %>%
  arrange(desc(avg_auroc)) %>%
  pull(predictor)

roc_1mb <- roc_1mb %>%
  ungroup() %>%
  mutate(predictor = factor(predictor, levels = order))

# create labels to add auroc to plots
auroc_labels <- auroc_1mb %>%
  left_join(select(auroc_stats_1mb, predictor, avg_auroc), by = "predictor") %>%
  mutate(predictor = factor(predictor, levels = order)) %>%
  mutate(label = paste0("AUC: ", round(auc, digits = 2))) %>%
  mutate(x = 0.8, y = if_else(sample == "chr11", true = 0.25, false = 0.1))

# plot roc curves for every predictor
ggplot(roc_1mb, aes(x = FPR, y = TPR, color = sample)) +
  facet_wrap(~predictor, ncol = 2) +
  geom_line(size = 1) +
  geom_abline(lty = "dashed", color = "darkgray") +
  geom_text(data = auroc_labels, aes(x, y, label = label), show.legend = FALSE) +
  labs(color = "Region") +
  scale_color_manual(values = c("chr11" = "indianred3", "chr8" = "steelblue")) +
  theme_bw() +
  theme(legend.position = "top",
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13))
```

***

# Source
* <a download="abc_analysis_screen.Rmd" href="`r base64enc::dataURI(file = params$rmd,
    mime = 'text/rmd', encoding = 'base64')`">R Markdown source file (to produce this document)</a>
